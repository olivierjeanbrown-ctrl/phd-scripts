# mixed_model_cdrisc.R
# --------------------
# Purpose: Fit a linear mixed effects model examining interaction of CD-RISC 10 and group over time
# Language: R
# Dependencies: tidyverse, lme4, lmerTest, emmeans, effectsize, rio, easystats, ggstatsplot
# Notes: Replace "raw/data_placeholder.csv" with actual data locally; do not commit confidential data
# Load/Install required packages ---------------------
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, lme4, lmerTest, emmeans, effectsize, rio, easystats, ggstatsplot, report, marginaleffects, merDeriv)
# Run this line of code ONCE (then delete from your scripts)
#rio::install_formats()
#### Data ####
data <- rio::import("raw/data_placeholder.csv", na.strings = c("", "NA"))   # set empty strings and "NA" as missing
data <- data %>%
mutate(randomization = factor(randomization),  # categorical
sex = factor(sex),                      # categorical
age = calc_age,                         # rename calc_age to age
subject_id = row_number())              # subject IDs for random effects
#### Reshape Long ####
data_long <- data %>%
select(subject_id, randomization, age, sex, cdrisc_72, cdrisc_4w) %>%  # keep only variables needed from csv
pivot_longer(cols = c(cdrisc_72, cdrisc_4w),                           # reshape to long format
names_to = "timepoint",
values_to = "cdrisc_score") %>%
mutate(timepoint = factor(timepoint,                                    # relabel timepoints to baseline follow-up
levels = c("cdrisc_72", "cdrisc_4w"),
labels = c("Baseline", "Follow-up")),
randomization = factor(randomization,                            # relabel groups to mbi control
levels = c("0", "1"),
labels = c("MBI", "Control")))
#### Model ####
mixed_model <- lmer(cdrisc_score ~ timepoint * randomization + age + sex + (1 | subject_id),
data = data_long)   # fit random intercept mixed model with timepoint, group, age, sex
summary(mixed_model)                     # print model summary with fixed effects and p-values
# Testing the impact of the random effect on the DV.
model <- lm(cdrisc_score ~ timepoint * randomization + age + sex, data = data_long)
report(model)
# When running the mixed model p-value goes from 0.055 to 0.038
rm(model)
#### Results ####
print_model_results <- function(model, model_name) {
sm <- summary(model)                             # summary
cat(model_name, "Results:\nFixed Effects:\n")    # print header
print(sm$coefficients)                           # coefficients table
cat("Effect sizes (Standardized Betas):\n")
print(standardize_parameters(model))             # standardized coefficients
cat("95% Confidence Intervals:\n")
print(confint(model, method = "Wald"))           # confidence intervals
cat("\n")
}
print_model_results(mixed_model, "Mixed Model")    # call function to print results for mixed model
# ▬ Redoing using easystats ----
tbl.parameters <- model_parameters(mixed_model) # make a table of the mixed model parameters
report(mixed_model)
#### Plot ####
# 1. The model
model <- lmer(cdrisc_score ~ timepoint * randomization + age + sex + (1 | subject_id),
data = data_long)
# 2. Obtain estimated means (MODIFIED)
means <- estimate_means(model, by = c("timepoint", "randomization"))
means
# 3. Custom plot
plot1 <- ggplot(data_long, aes(x = timepoint, y = cdrisc_score)) +
geom_violin(aes(fill = timepoint), color = "white") +
geom_jitter(width = 0.1, height = 0, alpha = 0.5, size = 3) +
geom_line(data = means, aes(y = Mean, group = 1), linewidth = 1) +
geom_pointrange(
data = means,
aes(y = Mean, ymin = CI_low, ymax = CI_high),
size = 1,
color = "white"
) +
facet_wrap(~ randomization) +   # ← ONLY NEW LINE
scale_fill_manual(values = c("pink", "lightblue")) +
labs(title = "CD-RISC 10 Scores Over Time by Group",
x = "Time point", y = "CD-RISC 10 Score", color = "  ", fill = " ") +
theme_minimal(base_size = 16) +
theme(plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
axis.title = element_text(size = 16),
axis.text = element_text(size = 14),
legend.title = element_text(size = 15),
legend.position = "top",
legend.text = element_text(size = 13))
ggsave("images/Figure_2B.png", plot1, width=11, height=8.5, dpi=300)
